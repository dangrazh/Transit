Private bFound As Boolean

Function fctParseXML(rInputCell As Range, sxmlTag As String) As String

    Dim stXML As String
    
    Dim objXML As New MSXML2.DOMDocument60
    Dim point As IXMLDOMNode
    Dim attributes As IXMLDOMNodeList
    Dim node As IXMLDOMNode
    Dim stNodeName As String
    Dim sXmlValue As String
    
    
    sXmlValue = "n/a"
    bFound = False
    
    fctParseXML = sXmlValue
    
    If Len(rInputCell.Value) = 0 Then
        Exit Function
    End If

    stXML = rInputCell.Value
    If Not objXML.LoadXML(stXML) Then  'strXML is the string with XML'
        'Err.Raise objXML.parseError.ErrorCode, , objXML.parseError.reason
        Exit Function
    End If
    
    Set attributes = objXML.DocumentElement.ChildNodes
    
    Call fetchXmlTag(attributes, sxmlTag, sXmlValue)
    fctParseXML = sXmlValue
    
    'Call printXML(attributes, 0)
    
End Function

Sub fetchXmlTag(myNodeList As Variant, sxmlTag As String, ByRef sTagValue As String)

    Dim node As IXMLDOMNode

    For Each node In myNodeList
        'Debug.Print Space(iLevel * 2) & node.nodeName & " -> " & node.nodeTypedValue
        stNodeName = node.nodeName
        If stNodeName = sxmlTag Then
            sTagValue = node.nodeTypedValue
            'Debug.Print node.nodeName & " -> " & node.nodeTypedValue
            bFound = True
            Exit Sub
        End If
        
        If node.ChildNodes.Length > 0 And bFound = False Then
            Call fetchXmlTag(node.ChildNodes, sxmlTag, sTagValue)
        End If
        
        If bFound = True Then
            Exit Sub
        End If
        
    Next


End Sub
    




Sub printXML(myNodeList As Variant, iLevel As Long)

    Dim node As IXMLDOMNode

    For Each node In myNodeList
        Debug.Print Space(iLevel * 2) & node.nodeName & " -> " & node.nodeTypedValue
        If node.ChildNodes.Length > 0 Then
            Call printXML(node.ChildNodes, iLevel + 1)
        End If
'        stNodeName = node.nodeName
'        If stNodeName = sXmlTag Then
'            fctParseXML = node.nodeTypedValue
'            Exit For
'        End If
    Next


End Sub
    

